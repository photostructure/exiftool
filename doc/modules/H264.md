# H264.pm Module Outline

**ExifTool Version:** 13.26
**Module Version:** 1.17
**Document Version:** 1.0
**Last Updated:** 2025-06-30

## Overview

The H264.pm module extracts comprehensive metadata from H.264 video streams, particularly focusing on AVCHD videos. It implements sophisticated H.264 bitstream parsing, including NAL unit processing, SEI message decoding, and manufacturer-specific metadata extraction. The module supports advanced features like MDPM (Modified Digital Video Pack Metadata) parsing, GPS data extraction, and complex camera settings interpretation.

## Module Structure

### Tag Tables (8 total)

1. **Main** - Core H.264 video metadata (2 fields)

   - ImageWidth/ImageHeight extracted from sequence parameter sets
   - MDPM subdirectory for advanced metadata

2. **MDPM** - Modified Digital Video Pack Metadata (60+ fields)

   - Core metadata from UUID 17ee8c60f84d11d98cd60800200c9a66
   - Camera settings, exposure data, GPS information
   - Manufacturer-specific conditional processing

3. **Camera1** - Consumer camera settings 1 (4 fields)

   - Aperture, gain, exposure program, white balance
   - Binary data with bit masking operations

4. **Camera2** - Consumer camera settings 2 (1 field)

   - Image stabilization with hex value interpretation

5. **Shutter** - Shutter speed information (1 field)

   - Little-endian format exposure time calculation

6. **MakeModel** - Manufacturer identification (1 field)

   - Make identification with manufacturer lookup table

7. **RecInfo** - Canon recording information (1 field)

   - Recording mode for Canon cameras (XP+, SP, LP, FXP, MXP)

8. **FrameInfo** - Canon frame rate data (2 fields)
   - Capture and video frame rates for Canon cameras

### Key Data Structures

- **Manufacturer Lookup**: %convMake hash mapping hex codes to manufacturer names
- **BitStream Objects**: Custom bitstream processing with position tracking
- **NAL Unit Parser**: Network Abstraction Layer unit identification and processing
- **SEI Payload Processing**: Supplemental Enhancement Information message handling
- **UUID Recognition**: Specific UUID-based metadata block identification
- **Combined Tag Processing**: Multi-tag value combination for complex data types

## Processing Architecture

### 1. Main Processing Flow

H.264 processing follows the video specification exactly:

1. **Video Stream Parsing**: Identifies H.264 NAL units in bitstream
2. **NAL Unit Classification**: Processes SEI (0x06) and sequence parameter set (0x07) units
3. **Byte Stuffing Removal**: Removes H.264 0x000003 â†’ 0x0000 stuffing bytes per spec
4. **SEI Message Parsing**: Extracts metadata from Supplemental Enhancement Information
5. **UUID-based Routing**: Routes specific UUID payloads to MDPM processing
6. **Multi-frame Support**: Continues parsing if metadata not found in first frame

### 2. Special Processing Functions

- **ProcessSEI**: Core SEI message parser with UUID detection and MDPM extraction
- **ParseH264Video**: Main entry point with NAL unit identification and processing
- **ParseSeqParamSet**: Complex sequence parameter set parsing for image dimensions
- **ProcessBinaryData**: Camera settings parsing with bit masking operations
- **BitStream Functions**: Custom bit-level data extraction (GetIntN, GetGolomb, GetGolombS)

## Key Features

### 1. Advanced Bitstream Processing

- **Exp-Golomb Decoding**: GetGolomb/GetGolombS for H.264 integer encoding
- **Arbitrary Bit Reading**: GetIntN for precise bit-level data extraction
- **Position Tracking**: Sophisticated bitstream position and mask management
- **Byte Order Support**: Little-endian processing for specific camera data

### 2. MDPM Metadata System

- **UUID-based Detection**: Specific UUID 17ee8c60f84d11d98cd60800200c9a66 identification
- **Sequential Processing**: Ordered tag processing with out-of-sequence detection
- **Combined Tag Support**: Multi-tag combination for complex data types (GPS coordinates, date/time)
- **Manufacturer Conditions**: Camera-specific tag processing based on Make

### 3. H.264 Specification Implementation

- **NAL Unit Parsing**: Proper Network Abstraction Layer unit identification
- **Sequence Parameter Sets**: Complete parsing for image dimensions with cropping
- **VUI Parameters**: Video Usability Information parsing for timing data
- **Scaling Matrices**: H.264 scaling matrix decoding support

### 4. Manufacturer-Specific Support

- **Canon Integration**: RecInfo and FrameInfo for Canon video cameras
- **Sony Model Detection**: Model name extraction from camera settings
- **Panasonic Compatibility**: Manufacturer detection and multi-frame parsing
- **JVC Recognition**: Basic manufacturer identification

### 5. GPS Data Processing

- **Complete GPS Suite**: All standard GPS tags (position, altitude, time, speed, direction)
- **Coordinate Combination**: Degrees/minutes/seconds tag combination
- **Reference Processing**: Latitude/longitude reference handling
- **Timestamp Conversion**: GPS time format processing

### 6. Camera Settings Interpretation

- **Exposure Data**: Complete exposure triangle (aperture, shutter, ISO)
- **Focus Information**: Auto/manual focus with position data
- **White Balance**: Multiple white balance modes and bias information
- **Image Stabilization**: Stabilization status with hex code interpretation

## Special Patterns

### 1. Manufacturer-Conditional Processing

```perl
Condition => '$$self{Make} eq "Canon"',
Condition => '$$self{Make} eq "Sony"',
```

### 2. Combined Tag Processing

```perl
Combine => 1,    # Next tag contains rest of data
Combine => 2,    # Next 2 tags contain additional data
```

### 3. BitStream Object Management

```perl
my $bstr = NewBitStream($dataPt);
my $val = GetGolomb($bstr);
```

### 4. UUID-based Metadata Detection

```perl
substr($$dataPt, $pos, 20) eq "\x17\xee\x8c\x60\xf8\x4d\x11\xd9\x8c\xd6\x08\0\x20\x0c\x9a\x66MDPM"
```

### 5. NAL Unit Processing

```perl
my %parseNalUnit = ( 0x06 => 1, 0x07 => 1 );    # SEI and sequence parameter sets
```

## Usage Notes

### 1. Processing Requirements

- H.264 streams must contain proper NAL unit structure
- MDPM metadata requires specific UUID presence
- Manufacturer identification affects available tags
- Some cameras require multi-frame parsing

### 2. Bitstream Limitations

- Complex H.264 features may not be fully supported
- Picture timing parsing disabled by default (test flag required)
- VUI parameter parsing incomplete for some advanced features
- Scaling matrix decoding implemented but not extensively tested

### 3. Manufacturer Dependencies

- Canon-specific tags only available with Canon Make identification
- Sony model extraction requires specific camera firmware
- Some tags behave differently across manufacturers
- Generic processing available for unknown manufacturers

### 4. GPS Data Requirements

- GPS tags require proper coordinate reference processing
- Combined tags must be processed in sequence
- GPS timestamp requires proper format conversion
- Some GPS fields may be manufacturer-specific

## Debugging Tips

### 1. NAL Unit Issues

- Use verbose mode to see NAL unit types and sizes
- Check for proper forbidden_zero_bit handling
- Verify byte stuffing removal (0x000003 sequences)
- Monitor NAL unit type filtering

### 2. Bitstream Problems

- Enable verbose mode for bitstream position tracking
- Check Exp-Golomb decoding with known values
- Verify bit alignment and mask operations
- Monitor for premature end-of-stream conditions

### 3. MDPM Processing

- Verify UUID presence in SEI payload type 5
- Check tag sequence ordering (must be numerical)
- Monitor combined tag processing for multi-part values
- Watch for manufacturer-specific conditional processing

### 4. Sequence Parameter Set Parsing

- Check image dimension extraction against known values
- Verify cropping parameter handling
- Monitor VUI parameter parsing for timing information
- Validate profile and level detection

### 5. Manufacturer Detection

- Verify Make field population from MakeModel table
- Check manufacturer-specific tag conditional processing
- Monitor for regional firmware variations
- Validate manufacturer code lookup table

### 6. Multi-frame Processing

- Check ParsedH264 flag to monitor frame processing
- Verify ExtractEmbedded option for multiple SEI extraction
- Monitor GotNAL06/GotNAL07 flags for duplicate processing
- Watch for Panasonic camera multi-frame requirements

### 7. Camera Settings Interpretation

- Verify bit mask operations for camera data
- Check value conversion formulas for exposure calculations
- Monitor hex value interpretation for settings
- Validate combined tag processing for complex values

### 8. Performance Considerations

- H.264 parsing is computationally intensive
- Large video files may require significant processing time
- Bitstream operations involve complex calculations
- Consider limiting frame parsing for performance
