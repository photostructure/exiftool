# Jpeg2000.pm Module Outline

**ExifTool Version:** 13.26
**Module Version:** 1.43
**Document Version:** 1.0
**Last Updated:** 2025-07-31

## Overview

The Jpeg2000.pm module provides comprehensive read/write support for JPEG 2000 images (JP2), JPEG XL (JXL), and related C2PA/JUMBF authentication metadata. This is a high-complexity file format module that implements box-based container processing, codestream handling, Brotli compression support, and full C2PA content authenticity framework integration for digital provenance verification.

## Module Structure

### Tag Tables (7 total)

1. **Main** (`%Image::ExifTool::Jpeg2000::Main`):
   - Primary box container handling (jp2h, uuid, xml, jumb, etc.)
   - Extensive subdirectory support for nested box structures
   - C2PA/JUMBF metadata processing with dynamic label-based tag creation
   - JXL (JPEG XL) and JP2 format support with format-specific processing

2. **ImageHeader** (`%Image::ExifTool::Jpeg2000::ImageHeader`):
   - Binary data processing for image dimensions and characteristics
   - BitsPerComponent with signed/unsigned format interpretation
   - Compression method identification (JPEG 2000, JBIG, JPEG-LS, etc.)

3. **FileType** (`%Image::ExifTool::Jpeg2000::FileType`):
   - Brand identification for JP2, JPM, JPX, JXL, JPH formats
   - Version information and compatibility matrix processing
   - Multi-brand support with list-based compatible brands

4. **CaptureResolution** (`%Image::ExifTool::Jpeg2000::CaptureResolution`):
   - Resolution specifications with rational32u format handling
   - Unit conversion system with metric/imperial resolution units
   - Separate X/Y resolution and unit processing

5. **DisplayResolution** (`%Image::ExifTool::Jpeg2000::DisplayResolution`):
   - Display-specific resolution metadata with unit specifications
   - Identical structure to CaptureResolution for display characteristics

6. **ColorSpec** (`%Image::ExifTool::Jpeg2000::ColorSpec`):
   - Color specification method handling (Enumerated, ICC, Vendor)
   - ICC Profile embedding with conditional subdirectory processing
   - ColorSpace enumeration with comprehensive color model support
   - Write support with method-specific data validation

7. **JUMD** (`%Image::ExifTool::Jpeg2000::JUMD`):
   - JUMBF description box processing for C2PA authentication
   - Dynamic label-based tag name generation
   - UUID type identification with hex conversion
   - Toggle flag processing with bitmask interpretation

### Key Data Structures

- **Resolution Units** (`%resolutionUnit`): Metric unit conversion table (km to Î¼m)
- **Image Data Detection** (`%isImageData`): Box types containing compressed image data
- **JP2/JXL Maps** (`%jp2Map`, `%jxlMap`): Write location mapping for metadata placement
- **UUID Directory Map** (`%uuid`): UUID-based subdirectory identification
- **J2C Markers** (`%j2cMarker`): JPEG 2000 codestream marker definitions

## Processing Architecture

### 1. Main Processing Flow

**ProcessJpeg2000Box Function** (`Jpeg2000.pm:1016-1359`):
- Recursive box structure processing with length handling
- Read/write pipeline with dynamic box creation and modification
- Extended length support for boxes >4GB (theoretical)
- Hash computation for image data integrity verification
- Error handling with truncation detection and recovery

**Box Processing Loop** (`Jpeg2000.pm:1065-1348`):
- Header parsing with 4/8-byte length field detection
- Box type identification and tag table lookup
- Conditional processing based on verbose/extraction requirements
- Write pipeline with selective box modification and pass-through

### 2. Special Processing Functions

**ProcessJUMB Function** (`Jpeg2000.pm:777-797`):
- C2PA JUMBF box hierarchy tracking with document numbering
- Nested subdocument level management
- Group assignment for multi-document metadata organization

**ProcessJUMD Function** (`Jpeg2000.pm:803-861`):
- JUMBF description box parsing with type/label/ID extraction
- Dynamic tag name generation based on JUMBFLabel content
- Unicode string processing with null termination handling
- Private data section detection and processing

**ProcessBrotli Function** (`Jpeg2000.pm:1392-1463`):
- Brotli compression/decompression for JXL metadata
- Type detection (exif, xml, jumb) with case normalization
- Compression option handling with conditional recompression
- Error handling with library availability checking

**ProcessJXLCodestream Function** (`Jpeg2000.pm:1469-1510`):
- JXL codestream parameter extraction without full decode
- Bitstream parsing for image dimensions
- Aspect ratio calculation with predefined ratio tables
- Small/large format detection with appropriate bit field handling

### 3. File Format Support

**ProcessJP2 Function** (`Jpeg2000.pm:1538-1597`):
- JP2/JPX/JPM/JXL container format detection
- Write directory initialization with format-specific mapping
- Codestream fallback processing for raw J2C files
- Byte order management (big-endian for JPEG 2000)

**ProcessJXL Function** (`Jpeg2000.pm:1603-1653`):
- JPEG XL container vs. codestream detection
- Automatic container wrapping for codestream-only files
- Brotli metadata compression integration
- Container box attachment for hybrid processing

**ProcessJUMBF Function** (`Jpeg2000.pm:1516-1532`):
- C2PA/JUMBF standalone file processing
- File type detection based on box signatures
- Content authenticity metadata extraction

## Key Features

1. **Multi-Format Support**: JP2, JPX, JPM, JXL, J2C, C2PA/JUMBF
2. **Box Architecture**: Complete ISO BMFF container processing
3. **C2PA Integration**: Full content authenticity framework support
4. **Brotli Compression**: JXL metadata compression/decompression
5. **Codestream Processing**: Basic parameter extraction from bitstreams
6. **Write Capabilities**: Metadata injection with proper box structure
7. **UUID Handling**: Multiple UUID-based metadata types (EXIF, XMP, IPTC)
8. **Extended Length**: Support for large box sizes with 64-bit lengths

## Special Patterns

1. **Dynamic Tag Creation**: JUMBF labels converted to tag names with C2PA-specific handling
2. **Conditional Processing**: Box content determines subdirectory table selection
3. **Format Detection**: Multiple signature patterns for different JPEG 2000 variants
4. **Compression Integration**: Transparent Brotli handling for JXL metadata
5. **Box Hierarchy**: Nested processing with parent-child relationships
6. **Write Mapping**: Format-specific directory location tables
7. **Image Data Hashing**: Selective hash computation for integrity verification

## Usage Notes

- JPEG 2000 files use big-endian byte order throughout
- JXL supports both container and codestream formats
- C2PA metadata provides content authenticity and provenance tracking
- Brotli compression is optional for JXL metadata (requires IO::Compress::Brotli)
- UUID boxes support multiple metadata standards (EXIF, XMP, IPTC, GeoJP2)
- Write operations preserve box structure and ordering requirements
- Extended length boxes (>4GB) supported but may have practical limitations

## Debugging Tips

1. **Box Structure**: Use verbose mode (`-v`) to see detailed box hierarchy processing
2. **UUID Issues**: Check 16-byte UUID signatures for proper metadata type detection
3. **JXL Problems**: Verify container vs. codestream format distinction
4. **C2PA Metadata**: Use `-jumbf:all -G3 -b -j -u -struct` for complete extraction
5. **Brotli Errors**: Install IO::Compress::Brotli and IO::Uncompress::Brotli for JXL support
6. **Color Spec**: Verify ICC profile compatibility when writing color specifications
7. **Codestream**: Check marker sequences for proper J2C format detection

## Implementation Details

**File Location**: `lib/Image/ExifTool/Jpeg2000.pm`
**Dependencies**: Image::ExifTool::XMP, Image::ExifTool::Exif, Image::ExifTool::IPTC, Image::ExifTool::ICC_Profile, Image::ExifTool::CBOR, Image::ExifTool::JSON
**Line Count**: 1696 lines (very high complexity)
**Complexity**: Very High - multiple file format support with advanced metadata handling
**Specifications**: ISO/IEC 15444 (JPEG 2000), ISO 18181-2 (JXL), C2PA v1.3, JUMBF
**Maintenance**: Active - ongoing updates for C2PA authentication and JXL format evolution